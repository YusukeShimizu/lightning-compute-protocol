name: proto-go

on:
  push:
    branches:
      - main
    paths:
      - go-lcpd/proto/**
      - proto/**
      - proto-go/**
      - .github/workflows/proto-go.yml
  pull_request:
    paths:
      - go-lcpd/proto/**
      - proto/**
      - proto-go/**
      - .github/workflows/proto-go.yml
  workflow_dispatch:

jobs:
  proto-go:
    name: proto-go (buf lint + generate check)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v9
        with:
          diagnostic-endpoint: ""
          use-gha-cache: true
          use-flakehub: false

      - name: Lint protos
        run: nix develop ./go-lcpd -c sh -lc 'cd go-lcpd && buf lint'

      - name: Verify proto-go generated code is up to date
        run: |
          nix develop ./go-lcpd -c sh -lc 'cd go-lcpd && buf generate --template ../proto-go/buf.gen.yaml'
          git diff --exit-code -- proto-go

